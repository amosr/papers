%!TEX root = ../Main.tex

\begin{figure}
\begin{tabbing}
MMMM \= M \= MMMMMMMMMMM \= \kill
$v$  \> $=$ \> $@Scalar@~v_x$ \> $|~ @Elements@~\ov{v_x}$ \\
$v_x$\> $=$ \> $\NN$ \> $|~ \BB$ \\
\end{tabbing}
\TODO{these should go in the grammar}

\caption{Definitions for evaluation rules}
\label{fig:source:eval}
\end{figure}

\begin{figure*}

$$
\boxed{\Bigstep{\ov{\mi{Function}}}{\mi{Exp}}{v}}
$$

$$
\ruleI
{
}
{
    \Bigstep{f}{v}{v}
}
\textrm{(EvValue)}
\quad
\ruleI
{
    p \in \mi{Prim}
    \quad
    \Bigstep{f}{x}{@Scalar@~v}
    \quad
    \Bigstep{f}{y}{@Scalar@~v'}
}
{
    \Bigstep{f}{p~x~y}{@Scalar@~(p~v~v')}
}
\textrm{(EvPrimScalar)}
$$

$$
\ruleI
{
    p \in \mi{Prim}
    \quad
    \Bigstep{f}{x}{v}
    \quad
    \Bigstep{f}{y}{v'}
    \quad
    (v~=~@Elements@~\_)~\vee~(v'~=~@Elements@~\_)
}
{
    \Bigstep{f}{p~x~y}{@Elements@~(\mi{zip}~p~(\mi{elements}~v~v')~(\mi{elements}~v'~v))}
}
\textrm{(EvPrimElements)}
$$

$$
\ruleI
{
    (f',~\mi{args},~\mi{exp}) = \mi{split}~f~n
    \quad
    \Bigstep{f}{\mi{xs}\ldots}{\mi{vs}\ldots}
    \quad
    \Bigstep{f'}{\mi{exp}[\mi{args}~:=~\mi{vs}]}{v}
}
{
    \Bigstep{f}{n~xs}{v}
}
\textrm{(EvFunApp)}
$$

$$
\ruleI
{
    \Bigstep{f}{x}{v}
    \quad
    \Bigstep{f}{x[n~:=~v]}{v'}
}
{
    \Bigstep{f}{@let@~n~=~x~@in@~x'}{v'}
}
\textrm{(EvLet)}
$$

$$
\ruleI
{
    \Bigstep{f}{c}{c'}
    \quad
    \Bigstep{f}{x}{x'}
}
{
    \Bigstep{f}{c~@where@~x}{\mi{zip}~(\wedge)~c'~x'}
}
\textrm{(EvWhere)}
$$

$$
\ruleI
{
    \Bigstep{f}{c}{c'}
    \quad
    \Bigstep{f}{z}{v_z}
    \quad
    f~|~0~|~c'~|~[v_z]~|~k~\Downarrow_{Fold}~v'
}
{
    \Bigstep{f}{@fold@[c]~n~=~z~@then@~k}{v'}
}
\textrm{(EvFold)}
$$

$$
\boxed{\ov{\mi{Function}}~|~\NN~|~\ov{\BB}~|~\ov{v_x}~|~\mi{Exp}~\Downarrow_{Fold}~v_x}
$$

$$
\ruleI
{
    v~=~\mi{last}~vs
}
{
    f~|~i~|~\emptyset~|~vs~|~k~\Downarrow_{Fold}~v
}
\textrm{(EvFoldNil)}
$$

$$
\ruleI
{
    \Bigstep{f}{k[n~:=~z]}{v}
    \quad
    v'~=~\mi{index}~v~i
    \quad
f~|~(i+1)~|~c~|~(vs;v')~|~k~\Downarrow_{Fold}~vs'
}
{
f~|~i~|~(@T@;~c)~|~vs~|~k~\Downarrow_{Fold}~vs'
}
\textrm{(EvFoldClockTrue)}
$$

$$
\ruleI
{
    v'~=~\mi{last}~vs
    \quad
f~|~(i+1)~|~c~|~(vs;v')~|~k~\Downarrow_{Fold}~vs'
}
{
f~|~i~|~(@F@;~c)~|~vs~|~k~\Downarrow_{Fold}~vs'
}
\textrm{(EvFoldClockFalse)}
$$




where
\begin{tabbing}
$\mi{elements}~:~v~\to~v~\to~\ov{v_x}$\\
$\mi{elements} (@Scalar@~v)~(@Elements@~xs) = [v~|~\_~\in~xs]$\\
$\mi{elements} (@Elements@~xs)~\_ = xs$\\
\\
$\mi{split}~:~\ov{\mi{Function}}~\to~n~\to~(\ov{\mi{Function}},~\ov{n},~\mi{Exp})$\\
$\mi{split} (f;@function@~n~\mi{args}~\mi{exp})~n~=~(f,~\mi{args},~\mi{exp})$ \\
$\mi{split} (f;\_)~n~=~\mi{split}~f~n$ \\
\end{tabbing}

\caption{Evaluation rules}
\label{fig:source:eval}
\end{figure*}


