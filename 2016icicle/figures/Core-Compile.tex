%!TEX root = ../Main.tex

\begin{figure*}

\newcommand \acc {\tau_\mathit{acc}}
\newcommand \xtr {\tau_\mathit{extract}}
\newcommand \lam[1] {\lambda{} #1.~}

$$
\boxed{\ToCoreX{x}{M~\tau}{@CoreExp@}}
$$

$$
\ruleI
{
}
{ 
    \ToCoreX{x}{\Agg{\tau}}{@bottom@~:~\Agg{\tau}}
}
\textrm{(CoreXAgg)}
$$
\TODO{This judgment is only used for pure or element computations. Any aggregates inside here must be dead code, so we need not convert it.}

$$
\ruleI
{
}
{ 
    \ToCoreX{n}{M~\tau}{n}
}
\textrm{(CoreVar)}
\quad
\ruleI
{
}
{ 
    \ToCoreX{\_}{v}{M~\tau}{v}
}
\textrm{(CoreValue)}
$$

$$
\ruleI
{
    \ToCoreX{x}{M_x~\tau_x}{x'}
    \quad
    \ToCoreX{y}{M_y~\tau_y}{y'}
}
{ 
    \ToCoreX{p~x~y}{M~\tau}{p~x'~y'}
}
\textrm{(CorePrim)}
$$

$$
\ruleI
{
    \ToCoreX{x}{M_x~\tau_x}{x'}
    \quad
    \ToCoreX{y}{M_y~\tau_y}{y'}
}
{ 
    \ToCoreX{@let@~n~=~x~@in@~y}{M~\tau}{@let@~n~=~x'~@in@~y'}
}
\textrm{(CoreLet)}
$$


$$
\boxed{\ToCore{n}{x}{M~\tau}{@Program@}}
$$
\TODO{Actually this returns a slightly different kind of program with only one unnamed output (call it return)}


$$
\ruleI
{
    n_f~\in~\mi{fresh}
    \quad
    \ToCoreX{x}{M~\tau}{x'}
}
{ 
    \ToCore{\_}{x}{M~\tau}{@Befores@~n_f~=~x';~@Return@~n_f}
}
\textrm{(CorePre)}
$$

$$
\ruleI
{
}
{ 
    \ToCore{\_}{p}{M~\tau}{@Return@~n}
}
\textrm{(CoreVar)}
\quad
\ruleI
{
    n_f~\in~\mi{fresh}
}
{ 
    \ToCore{\_}{v}{M~\tau}{@Befores@~n_f~=~v;~@Return@~n_f}
}
\textrm{(CoreValue)}
$$



\caption{Conversion to Core}
\label{fig:core:compile}
\end{figure*}


