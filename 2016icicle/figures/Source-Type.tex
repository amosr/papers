%!TEX root = ../Main.tex

\begin{figure}

\begin{tabbing}
MM \= M \= AggregateM \= M \= ElementM \= M \= \kill
$M$
    \> $=$  \> $@Aggregate@$ \> $~|~$ \> $@Element@$ \> $~|~$ \> $@Pure@$         \\
\\
$T_{\to}$
    \> $=$  
            \> $M~\tau~\to~T_{\to}$
            \> $~|~$
            \> $M~\tau$ \\
\\
$\Gamma$
    \> $=$  
            \> $\cdot$
            \> $~|~$
            \> $\Gamma,~n~:~T_\to$ \\
\end{tabbing}

\caption{Type definitions}
\label{fig:source:type:defs}
\end{figure}


\begin{figure*}

$$
\boxed{\TypecheckPrim{p}{T_\to}}
$$


$$
\ruleI
{
}
{ 
    \TypecheckPrim{@+@}{\NN~\to~\NN~\to~\NN}
}
\textrm{(TcPrimAdd)}
\quad
\ruleI
{
}
{
    \TypecheckPrim{@>@}{\NN~\to~\NN~\to~\BB}
}
\textrm{(TcPrimGt)}
$$

\caption{Typing primitives}
\label{fig:source:type:prim}
\end{figure*}


\begin{figure*}

$$
\boxed{\WrapMode{T_{\to}}{M}{T_{\to}}}
$$

$$
\ruleI
{
    \WrapMode{\tau}{m}{\tau'}
}
{
    \WrapMode{(\phi~\to~\tau)}{m}{(\phi~\to~\tau')}
}
\textrm{(WrapModeArrow)}
$$

$$
\ruleI
{ }
{
    \WrapMode{@Element@~\tau}{@Element@}{@Element@~\tau}
}
\textrm{(WrapElement)}
\quad
\ruleI
{ }
{
    \WrapMode{@Aggregate@~\tau}{@Aggregate@}{@Aggregate@~\tau}
}
\textrm{(WrapAggregate)}
\quad
\ruleI
{ }
{
    \WrapMode{@Pure@~\tau}{m}{m~\tau}
}
\textrm{(WrapPure)}
$$


$$
\boxed{\WrapApp{T_{\to}}{[M~T]}{M~T}}
$$

$$
\ruleI
{
}
{
    \WrapApp{(m~\tau)}{[]}{m~\tau}
}
\textrm{(WrapAppFinished)}
\quad
\ruleI
{
    \WrapApp{\tau_f}{\tau_x}{\tau}
}
{
    \WrapApp{(m~\phi~\to~\tau_f)}{(m~\phi;~\tau_x)}{\tau}
}
\textrm{(WrapAppEqual)}
\quad
\ruleI
{
    \WrapMode{\tau_f}{m}{\tau_f'}
    \quad
    \WrapApp{\tau_f'}{\tau_x}{\tau}
}
{
    \WrapApp{(@Pure@~\phi~\to~\tau_f)}{(m~\phi;~\tau_x)}{\tau}
}
\textrm{(WrapAppPure)}
$$

\caption{Function application with unboxing}
\label{fig:source:type:wrap}
\end{figure*}

\begin{figure*}

$$
\boxed{\Typecheck{\Gamma}{x}{M~T}}
$$


$$
\ruleI
{
    (n~:~\mu~\tau)~\in~\Gamma
}
{ 
    \Typecheck{\Gamma}{n}{\mu~\tau}
}
\textrm{(TcVar)}
\quad
\ruleI
{
    \tau~=~\NN~\vee~\tau~=~\BB
    \quad
    v~\in~\tau
}
{
    \Typecheck{\Gamma}{@Scalar@~v}{@Pure@~\tau}
}
\textrm{(TcScalar)}
\quad
\ruleI
{
    \tau~=~\NN~\vee~\tau~=~\BB
    \quad
    v~\in~\ov{\tau}
}
{
    \Typecheck{\Gamma}{@Elements@~v}{@Element@~\tau}
}
\textrm{(TcElements)}
\quad
\ruleI
{
    \Typecheck{\Gamma}{x}{@Pure@~\tau}
}
{
    \Typecheck{\Gamma}{x}{\mu~\tau}
}
\textrm{(TcBox)}
$$

$$
\ruleI
{
    (n~:~\tau_f)~\in~\Gamma
    \quad
    \Typecheck{\Gamma}{x\ldots}{\tau_x\ldots}
    \quad
    \WrapApp{\tau_f}{\tau_x\ldots}{\tau'}
}
{
    \Typecheck{\Gamma}{n~x\ldots}{\tau'}
}
\textrm{(TcAppVar)}
\quad
\ruleI
{
    \TypecheckPrim{p}{\tau_f}
    \quad
    \Typecheck{\Gamma}{x\ldots}{\tau_x\ldots}
    \quad
    \WrapApp{\tau_f}{\tau_x\ldots}{\tau'}
}
{
    \Typecheck{\Gamma}{p~x\ldots}{\tau'}
}
\textrm{(TcAppPrim)}
$$


$$
\ruleI
{
    \Typecheck{\Gamma}{x}{\tau}
    \quad
    \Typecheck{\Gamma,~n~:~\tau}{c}{\tau'}
}
{
    \Typecheck{\Gamma}{@let@~n~@=@~x~\flowsinto~c}{\tau'}
}
\textrm{(TcLet)}
$$

$$
\ruleI
{
    \Typecheck{\Gamma}{c}{@Elements@~\BB}
    \quad
    \Typecheck{\Gamma}{z}{@Pure@~\tau}
    \quad
    \Typecheck{\Gamma,~n~:~@Element@~\tau}{k}{@Element@~\tau}
}
{
    \Typecheck{\Gamma}{@fold@[c]~n~@=@~z~@then@~k}{@Aggregate@~\tau}
}
\textrm{(TcFold)}
$$

$$
\ruleI
{
    \Typecheck{\Gamma}{c}{@Element@~\BB}
    \quad
    \Typecheck{\Gamma}{x}{@Element@~\BB}
}
{
    \Typecheck{\Gamma}{c~@where@~x}{@Element@~\BB}
}
\textrm{(TcWhere)}
$$

\TODO{Add rules for Table, Function, Query etc}


\caption{Typing contexts}
\label{fig:source:type:ctx}
\end{figure*}

