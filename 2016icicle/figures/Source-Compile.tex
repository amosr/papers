%!TEX root = ../Main.tex

\begin{figure*}

\newcommand \acc {\tau_\mathit{acc}}
\newcommand \xtr {\tau_\mathit{extract}}
\newcommand \lam[1] {\lambda{} #1.~}

$$
\boxed{\ToCore{x}{\acc}{\acc~\to~\acc}{\acc~\to~\xtr}}
$$


$$
\ruleI
{
}
{ 
    \ToCore{n}{n}{\lam{\_} n}{\lam{\_} n}
}
\textrm{(CoreVar)}
$$

$$
\ruleI
{
    \ToCore{p}{z_p}{k_p}{x_p}
    \quad
    \ToCore{p}{z_q}{k_q}{x_q}
}
{ 
    \ToCore{f~p~q}{(z_p, z_q)}{\lam{a} (k_p~(@fst@~a), k_q~(@snd@~a))~}{\lam{a} f (@fst@~a) (@snd@~a)}
}
\textrm{(CoreApp2)}
$$

$$
\ruleI
{
    \ToCore{b}{z}{k}{x}
    \quad
    \ToCore{c}{z'}{k'}{x'}
}
{ 
    \ToCore{@let@~n~@=@~b~\flowsinto~c}{@let@~n~@=@~z~@in@~z'}{@let@~n~@=@~k~@in@~k'}{@let@~n~@=@~x~@in@~x'}
}
\textrm{(CoreVarLet)}
$$

$$
\ruleI
{
    \ToCore{f_z}{z}{\_}{\_}
    \quad
    \ToCore{f_k}{\_}{k}{\_}
    \quad
    \ToCore{c}{z'}{k'}{x'}
}
{ 
    \ToCore{@fold@~n~@=@~f_z@;@~f_k~\flowsinto~c}{@let@~n~@=@~z~@in@~(z,~z')}{@let@~n~@=@~k~@in@~(k,~k')}{@let@~n~@=@~@fst@~k~@in@~x'~(@snd@~k)}
}
\textrm{(CoreVarFold)}
$$

$$
\ruleI
{
    \ToCore{p}{\_}{p'}{\_}
    \ToCore{c}{z}{k}{x}
}
{ 
    \ToCore{@filter@~p~\flowsinto~c}{z}{@if@~p'~@then@~k~a~@else@~a}{x}
}
\textrm{(CoreVarFilter)}
$$



\caption{Conversion to Core}
\label{fig:source:core}
\end{figure*}


