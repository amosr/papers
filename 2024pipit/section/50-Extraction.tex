%!TEX root = ../Main.tex


\section{Extraction}
\label{s:extraction}

Pipit can generate executable code which is suitable for real-time execution on embedded devices.
The code extraction uses a variation of the abstract transition system described in \autoref{s:transition}, with two main differences to ensure that the result is executable without relying on the environment to provide values for the free context.
Contracts are straightforward to execute by using the body of the contract rather than abstracting over the implementation.

To execute recursive expressions $\xrec{x}{e} : \tau$, we require an arbitrary value of type $\tau$ to seed the fixpoint, as described in \autoref{s:core:causality}.
We first call the step function to evaluate $e$ with $x$ bound to $\bot_\tau$.
This step call returns the correct value, but the updated state is invalid, as it may refer to the bottom value.
To get the correct state, we call the step function again, this time with $e$ bound to $v$.

This translation to transition systems is verified to preserve the original semantics; however, it can duplicate work by requiring two calls to the step function.
To extract the above transition systems, we use \fstar{}'s normalisation-by-evaluation to generate step functions that update their mutable state in-place and which \lowstar{} can extract to C.
This normalisation strategy inlines the two step functions and is often able to remove the duplicate work.

Unfortunately, our current approach is also unsuitable for generating imperative array code, as our shallowly-embedded pure transition system requires pure arrays.
In the future, we intend to address array computations and the above work duplication by generating an explicit deeply-embedded imperative program.
We currently generate a monolithic step function for each Pipit program; an embedded foreign-function interface similar to that used by Accelerate~\cite{clifton2014embedding} may also enable separate-compilation of programs.

% \item staging: similarity to \cite{gallego2021w};
\CITE{Noise* code extraction} \cite{ho2022noise}