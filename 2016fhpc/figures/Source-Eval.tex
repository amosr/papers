%!TEX root = ../Main.tex

\begin{figure*}

$$
\boxed{\SourceStepX{M'}{E'}{V'}}
$$
$$
\ruleIN
{
    v~\in~V'
}
{
    \SourceStepX{m}{v}{v}
}{EVal}
\ruleIN
{
    \SourceStepXP{e}{\VValue{v}}
}
{
    \SourceStepXE{e}{\VStream{(\lam{\store} v)}}
}{EBoxStream}
\ruleIN
{
    \SourceStepXP{e}{\VValue{v}}
}
{
    \SourceStepXA{e}{\VFold{()}{(\lam{\store~()} ())}{(\lam{()} v)}}
}{EBoxFold}
$$

$$
\ruleIN
{
  \{ \SourceStepXP{e_i}{\VValue{v_i}} \}_i
}
{
  \SourceStepXP
    {p~\{ e_i \}_i }
    {\VValue{(p~\{v_i\}_i)}}
}{EPrimValue}
\ruleIN
{
  \{ \SourceStepXE{e_i}{\VStream{v_i}} \}_i
}
{
  \SourceStepXE
    {p~\{ e_i \}_i }
    {\VStream{(\lam{\store} p~\{v_i~\store\}_i)}}
}{EPrimStream}
$$

$$
\ruleIN
{
  \{ \SourceStepXA{e_i}{\VFold{z_i}{k_i}{x_i}} \}_i
}
{
  \SourceStepXA
    {p~\{ e_i \}_i }
    {\VFold
      {(\times_i~z_i)}
      {(\lam{\store~(\times_i~v_i)}
        \times_i (k_i~\store~v_i))}
      {(\lam{(\times_i~v_i)}
        p~\{x_i~v_i\}_i)}}
}{EPrimFold}
$$

$$
\ruleIN
{
  \SourceStepX{m'}{e}{v}
  \quad
  \SourceStepX{m}{e'[x:=v]}{v'}
}
{
  \SourceStepX
    {m}
    {@let@~(x~:~m'~\tau')~=~e~@in@~e'}
    {v'}
}{ELet}
\ruleIN
{
  \SourceStepXP{z}{\VValue{z'}}
  \quad
  \SourceStepXE{k[x:=\VStream{(\lam{\store} \store~x)}]}{\VStream{k'}}
}
{
  \SourceStepXA
    {@fold@~x~=~z~@then@~k}
    {\VFold
      {z'}
      {(\lam{\store~v} k'~(x:=v,~\store))}
      {(\lam{v} v)}}
}{EFold}
$$

$$
\ruleIN
{
  \SourceStepXE{p}{\VStream{p'}}
  \quad
  \SourceStepXA{e}{\VFold{z}{k}{x}}
}
{
  \SourceStepXA
    {@filter@~p~@of@~e}
    {\VFold
      {z}
      {(\lam{\store~v}
         @if@~p'~\store~@then@~k~\store~v~@else@~v)}
      {x}}
}{EFilter}
$$

$$
\ruleIN
{
  \SourceStepXE{p}{\VStream{p'}}
  \quad
  \SourceStepXA{e}{\VFold{z}{k}{x}}
}
{
  \SourceStepXA
    {@group@~p~@of@~e}
    {\VFold
      {\{\_~\Rightarrow~\bot\}}
      {(\lam{\store~m}
        @let@~k~=~p'~\store@,@~
              v~=~m~k~\vee~z
        ~@in@~
          m[k~\Rightarrow~k~\store~v])}
      {\{k_i~\Rightarrow~x~(m~k_i)\}_i}}
}{EGroup}
$$

$$
\begin{array}{ll}

\begin{array}{lll}
V & ::= & \NN~|~\BB~|~@Map@~(V \Rightarrow V_\bot)~|~(V~\times~\cdots~\times~V) \\
V'& ::= & \VValue{V}~|~\VStream{(\Sigma \to V)}~|~\VFold{V}{(\Sigma \to V \to V)}{(V \to V)}
\end{array}

&

\begin{array}{lll}
M'& ::= & @Pure@~|~@Element@~|~@Aggregate@ \\
E'& ::= & \mi{Exp}[V~:=~V']
\end{array}

\end{array}
$$


\caption{Evaluation rules}
\label{fig:source:eval}
\end{figure*}


